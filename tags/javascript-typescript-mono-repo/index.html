<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="chengcheng's blog"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="Sic Parvis Magna" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>javascript, typescript, mono-repo - Sic Parvis Magna</title>
<link rel="stylesheet" href="/css/main.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><meta name="generator" content="Hexo 5.2.0"></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Sic Parvis Magna</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2020-09-18T03:35:53.000Z" class="post__time">September 18, 2020</time><h1 class="post__title"><a href="/2020/09/18/ts-mono-settings/">monorepo基础设置指南</a></h1></header><div class="post__main echo"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在 JS 社区中，很多重量级的库和框架都使用 mono-repo 这种形式来组织代码，也可以说是项目逐渐复杂以后的一个必然选择。从 2017 年开始，公司 WEB 相关项目的代码组织方式也逐渐从由单个对项目组织慢慢过渡到了 monorepo。</p>
<p>写这篇文章的目的，一个是总结一下这些年用 monorepo 的各种坑以及一些感受，另一个也是记录一下设置的过程。值得注意的是，JS 社区发展和变化很快，就说 monorepo 这个事情，17 年到现在随着工具功能的迭代，就已经有了不少的变化，不过以后如果有什么新的东西也会更新在这里（大概 😏 ）。</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>首先，monorepo 是有许多不同的方案的，各方案有一些细微的区别，具体体现在对依赖的管理上。</p>
<p>很多文章讲 monorepo 都会提到一个叫 <a target="_blank" rel="noopener" href="https://github.com/lerna/lerna">lerna</a> 的工具。lerna 应该是比较早的多项目管理工具，可以很方便的进行多项目的构建、测试、发布等各种功能。lerna 可以搭配 npm，也可以搭配 yarn，其自身通过 symlinks 支持项目之间的代码本地复用。</p>
<p>我们都知道每个 package 都有自己的依赖声明，依赖安装在 package.json 同目录的 node_modules 中。monorepo 有个特点是包含多个 package，而且 monorepo 自己也是一个相对比较特殊的’package’（有自己的 package.json）。monorepo 依赖管理的核心就是如何管理各个 package 依赖，以及如何实现「本地复用」。这个「本地复用」指的是各子项目之间可以直接引用、复用代码，而不需要把包发布到 npm。</p>
<p>最开始 lerna 的方案比较直接，就是各个 package 都有一个自己的 node_modules，然后<code>lerna bootstrap</code>可以分析各 package 之间的本地依赖，通过 symlinks 自动链接。这个方案好处是简单直接，可以保证每个包的依赖相互独立，基本不出幺蛾子。然而有个问题：很多被重复依赖的包被安装很多次，而且这种重复依赖会很多。比如几乎所有包含业务逻辑的 package 可能都要安装 axios、momentjs 这类依赖，然后这类依赖继续往下会有更多的重复。</p>
<p>为了解决这个问题， lerna 后续增加了 hoisting 的功能。所谓「hoisting」就是可以把各 package 重复的「公共依赖」提升到根目录。 另外一个解决方案就是 <a target="_blank" rel="noopener" href="https://classic.yarnpkg.com/en/docs/workspaces/">yarn-workspace</a>。 yarn-workspace 的 hoisting 更进一步：不仅仅是把项目共同的依赖「提升」到 monorepo root，而是整个 repo 只有根目录有 node_modules。同样是利用 symlinks，yarn-workspace 的这种方案可以最大限度的减少包的重复安装问题。但是这种方式也会导致一些包工作不正常，所以有配套的 noHoist 配置，可以选择性的把一些包安装在项目本地，这里不展开，详情可以去看 yarn-workspace 的文档。</p>
<p>所以我们总结一下， monorepo 事实上有 4 种方案：</p>
<ul>
<li>lerna + yarn</li>
<li>lerna + npm</li>
<li>yarn-workspace</li>
<li>lerna + yarn-workspace</li>
</ul>
<p>前两种就是使用 lerna 来管理依赖，包括 hoisting 也是 lerna 提供。后两种核心是利用 yarn-workspace 来管理依赖，lerna 只作为一种可选的工具库，方便开发部署各 package 用的，本身已经不是必须。</p>
<p>这里都是以社区用的比较多的 lerna 来说，另外 lerna 还有一个 alternative：<a target="_blank" rel="noopener" href="https://github.com/boltpkg/bolt">bolt</a> 。不过我没有用过，谈不上什么经验。Bolt 从使用程度上来看和 lerna 还不是一个数量级。感兴趣的可以自己去 <a target="_blank" rel="noopener" href="https://openbase.io/">openbase.io</a> 上看一下。</p>
<p>我个人倾向的是第四种方案，也就是 lerna + yarn-workspace。使用 yarn-workspace 来管理依赖，然后使用 lerna 提供的很多便捷功能。</p>
<p>这篇文章对各种不同的方案做了一些性能测试:</p>
<p><a target="_blank" rel="noopener" href="https://doppelmutzi.github.io/monorepo-lerna-yarn-workspaces/">Why Lerna and Yarn Workspaces is a Perfect Match for Building Mono-Repos – A Close Look at Features and Performance</a>。</p>
<p>这篇文章推荐的也是 lerna + yarn-workspace 的方案。</p>
<p>使用 yarn-workspace 的话，需要使用的是 yarn 1.x 的「经典」版本，目前来看 yarn 2.x 的做法太过激进，批评的声音很多，怕坑太多还是先观望吧。</p>
<h2 id="yarn-workspace-lerna-monorepo-实施"><a href="#yarn-workspace-lerna-monorepo-实施" class="headerlink" title="yarn-workspace + lerna monorepo 实施"></a>yarn-workspace + lerna monorepo 实施</h2><p>值得注意的一点是，由于项目间共享的依赖都会被提升到 root 或者直接安装在 root（或者像 yarn-workspace 这样几乎所有依赖都安装在根目录），可能出现在某些 package 中不用声明也能直接使用一些依赖（这些包存在于其他某些项目的依赖中）。这些包在 monorepo 中测试运行正常，但是单独打包发布或者部署以后可能会出现某依赖找不到的问题。实际使用中需要注意一下，为了尽量避免这种问题推荐的做法是：</p>
<ul>
<li>在 workspace root 只安装开发相关依赖；</li>
<li>使用 <a target="_blank" rel="noopener" href="https://github.com/benmosher/eslint-plugin-import">eslint-plugin-import</a> 的 lint 规则对依赖进行检查</li>
</ul>
<p>同时也因为这个机制，我们可以把各 packages 都需要用到的依赖直接安装在 monorepo 的根目录，比如 eslint、babel、webpack 等各种可以在各项目之间「共享」的基础开发依赖。这样就不用在每个项目里都把 eslint，typescript，各种 plugin 啥的来一遍。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>文章接下来，我以我最常用和习惯的配置为蓝本，做一个实际的例子供大家参考。同时也算是一个备忘吧。</p>
<p>首先，做一些说明，后续的设置会和这几个假设相关：</p>
<ul>
<li>使用 vscode 作为 IDE。</li>
<li>使用最新版 typescript 作为主要开发语言。</li>
<li>使用 eslint 来规范项目的代码风格。</li>
<li>使用比较流行的 airbnb eslint config 作为基础 lint 规则。</li>
<li>使用 prettier 来对代码和各种源文件做格式化，统一风格。</li>
<li>项目中会同时包含前端项目（以 react 生态为主）和 nodejs （node latest LTS - 12.x +）的项目。</li>
<li>使用上面提到过的 lerna + yarn-workspace 作为 monorepo 方案。</li>
</ul>
<p>安装 yarn，安装 lerna（推荐全局安装，运行少打几个字，很方便），安装 vscode 和插件这些乱七八糟有手就行的就不啰嗦了。</p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create monorepo dir</span></span><br><span class="line">mkdir ts-mono</span><br><span class="line"></span><br><span class="line"><span class="comment"># quick init with lerna</span></span><br><span class="line"><span class="built_in">cd</span> ts-mono</span><br><span class="line">lerna init</span><br><span class="line"></span><br><span class="line"><span class="comment"># ignore node_modules, dist, lib director</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;\nnode_modules/\ndist/\nlib/&quot;</span> &gt;&gt; .gitignore</span><br></pre></td></tr></table></figure>

<p>这时项目基本是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ts-mono</span><br><span class="line">├── lerna.json</span><br><span class="line">├── package.json</span><br><span class="line">└── packages</span><br><span class="line">└── .gitignore</span><br></pre></td></tr></table></figure>

<h3 id="启用-yarn-作为包依赖管理工具，启用-yarn-workspace"><a href="#启用-yarn-作为包依赖管理工具，启用-yarn-workspace" class="headerlink" title="启用 yarn 作为包依赖管理工具，启用 yarn-workspace"></a>启用 yarn 作为包依赖管理工具，启用 yarn-workspace</h3><p>按照 lerna 文档上的说明（<a target="_blank" rel="noopener" href="https://github.com/lerna/lerna/blob/ef8380930742eb35bca1034808ceda2909852761/commands/bootstrap/README.md#--use-workspaces">参考</a>）。我们需要在<code>lerna.json</code>中添加 <code>npmClient: &quot;yarn&quot;</code> 以及 <code>useWorkspaces: true</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开lerna.json，添加如下配置</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;packages&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;packages/*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;npmClient&quot;</span>: <span class="string">&quot;yarn&quot;</span>,</span><br><span class="line">  <span class="string">&quot;useWorkspaces&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.0.0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照 yarn-workspace 文档上的说明（<a target="_blank" rel="noopener" href="https://classic.yarnpkg.com/en/docs/workspaces/#toc-how-to-use-it">参考</a>），我们需要在 monorepo 根目录下的 package.json 里增加「workspaces」的相关配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># package.json</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">      <span class="string">&quot;workspaces&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;packages&quot;</span>: [ <span class="string">&quot;packages/*&quot;</span> ],</span><br><span class="line">          <span class="string">&quot;nohoist&quot;</span>: []</span><br><span class="line">       &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种写法已经考虑了 nohoist 的场景，所以和最简单的情形不太一样（<code>workspaces: [&quot;packages/*&quot;]</code>），这里的 nohoist 上面提到过，目前可以不用管，不过相信以后你会用到:P。</p>
<h3 id="安装-VSCode-插件，配置-editorconfig-prettier"><a href="#安装-VSCode-插件，配置-editorconfig-prettier" class="headerlink" title="安装 VSCode 插件，配置 editorconfig, prettier"></a>安装 VSCode 插件，配置 editorconfig, prettier</h3><p>基于前述假设，推荐安装 vscode 的几个插件：</p>
<ul>
<li>dbaeumer.vscode-eslint<ul>
<li>可以在 vscode 中显示 lint 错误</li>
</ul>
</li>
<li>esbenp.prettier-vscode<ul>
<li>可以通过 <code>format document</code>命令或者保存的时候自动对代码进行格式化</li>
</ul>
</li>
<li>editorconfig.editorconfig<ul>
<li>覆盖用户的编辑器设定，对源代码文件和其他各种类型的文件做一个 indent、max line 等的基础设置</li>
</ul>
</li>
</ul>
<p><strong>配置 editorconfig</strong></p>
<p>于 monorepo 根目录创建配置文件 <code>.editorconfig</code>， editorconfig 插件会读取该文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: .editorconfig</span></span><br><span class="line">root = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*]</span><br><span class="line">charset = utf-8</span><br><span class="line">end_of_line = lf</span><br><span class="line">indent_style = space</span><br><span class="line">insert_final_newline = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*.&#123;js,jsx,ts,tsx,es6,sh,rb&#125;]</span><br><span class="line">indent_size = 2</span><br><span class="line">max_line_length = 80</span><br><span class="line">trim_trailing_whitespace = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*.&#123;py&#125;]</span><br><span class="line">indent_size = 4</span><br><span class="line">max_line_length = 80</span><br><span class="line">trim_trailing_whitespace = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[*.&#123;css,scss,less,html,json,yml,yaml&#125;]</span><br><span class="line">indent_size = 2</span><br><span class="line">trim_trailing_whitespace = <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>配置 prettier</strong></p>
<p>在 monorepo 根目录下创建 <code>prettier.config.js</code>文件，prettier 插件会读取该配置文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  printWidth: <span class="number">100</span>,</span><br><span class="line">  singleQuote: <span class="literal">true</span>,</span><br><span class="line">  trailingComma: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意 prettier 插件目前是不需要你在项目中安装 prettier 作为开发依赖的，应该是自带了。</p>
<h3 id="配置-typescript"><a href="#配置-typescript" class="headerlink" title="配置 typescript"></a>配置 typescript</h3><p>接下来应该是配置 eslint，然而配置 eslint 之前需要先配置一下 typescript，因为我们主开发语言是 typescript，所以需要替换 eslint 的 parser，ts 的 parser 依赖 typescript，所以我们需要把 monorepo 的 ts 先配置好。</p>
<p>typescript 配置 tsconfig.json 可以直接用 tsc 生成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in ts-mono/</span></span><br><span class="line">yarn add -D typescript</span><br><span class="line"></span><br><span class="line">tsc --init</span><br></pre></td></tr></table></figure>

<p>如果你没有全局安装 tsc，需要换成<code>npx tsc</code>。</p>
<p>我们的思路是在 monorepo 的根目录下丢一个 tsconfig.json，然后 packages/下面的其他 package 会有自己的 tsconfig.json,然后 extends monorepo 根目录下的这个配置。由于各 package 都会有自己的 tsconfig，所以根目录下的 tsconfig 只是定个调，不需要特别纠结，这里给出一个例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// node 12 =&gt; ES2019</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;ES2019&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;lib&quot;</span>: [<span class="string">&quot;ESNext&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;./&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;paths&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span>: <span class="literal">true</span> <span class="comment">/* Disallow inconsistently-cased references to the same file. */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tsconfig 主要还是需要参考 typescript 官方的<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig">配置说明文档</a>，这里面<code>skipLibCheck</code>, <code>strict</code>, <code>esModuleInterop</code>, <code>forceConsistentCasingInFileNames</code> 是比较关键的配置型。</p>
<h3 id="配置-eslint"><a href="#配置-eslint" class="headerlink" title="配置 eslint"></a><strong>配置 eslint</strong></h3><p>editorconfig 和 prettier 的配置简单直接，然而 eslint 就没那么省心了，值得单独拉出来多说几句。eslint 在使用的时候碰到过不少问题，总结出几点需要注意的：</p>
<ol>
<li>vscode-eslint 和 prettier 插件不一样：prettier 插件装完后可以作为 IDE 功能直接使用，eslint 插件需要自己安装 eslint 依赖，eslint 插件说自己会尝试寻找使用你安装的 eslint。</li>
<li><strong>不推荐</strong>全局安装 eslint， vscode-eslint 插件在文档中声明会优先使用你本地的 eslint。这样有个好处是出了问题比较容易定位。推荐把 eslint 作为开发依赖直接安装在 monorepo 的根目录，因为所有项目都需要。</li>
<li>如果使用 typescript，需要<code>@typescript-eslint/parser</code>来把 ts 代码解析成 ast，同时建议安装<code>@typescript-eslint/eslint-plugin</code>，包含了一些 ts 语言限定的规则。</li>
<li>prettier 和 eslint 的规则可能会<strong>互相冲突</strong>。 prettier 推荐的做法是使用他们提供的 eslint 配置，这个配置会关掉所有跟 format 相关的规则，也就是由 prettier 来复杂代码格式统一的问题（formatter），eslint 则主要检查代码的写法（linter）。现在比较新的语言如 go、rust 基本都自带 formatter 了，不像 JS 发挥空间这么大……</li>
<li>由于语言相同，monorepo 中的各 package 的 eslint 配置多多少少都是有相似的。但是具体到不同的项目，又会有很多差别。比如客户端项目需要 react 相关的插件和规则，后端项目则完全不需要。解决这种 eslint 配置「共享」的问题，有两种思路：<ul>
<li>第一种就是「<a target="_blank" rel="noopener" href="https://eslint.org/docs/user-guide/configuring#configuration-cascading-and-hierarchy">Configuration Cascading and Hierarchy</a>」，也就是 Cascading：父目录放一个 eslintrc,子目录放一个 eslintrc，在 lint 子目录的时候 eslint 会「合并」两个配置。<br>这个方式实际使用的时候并没有那么灵活，而且 vscode-eslint 插件对其支持的不是很好，对于比较复杂的结构还需要配置<code>workingDirectories</code>，实际使用发现本来正常工作的 eslint 会突然莫名其妙的在某个项目突然失效……</li>
<li>第二种则是按照 Eslint 推荐的「<a target="_blank" rel="noopener" href="https://eslint.org/docs/developer-guide/shareable-configs">Shareable Configs</a>」，解释一下就是：发布一个 eslint-config，里面包含各类规则，然后在其他项目里直接 extends 即可。<br>由于我们使用 monorepo，所以这个配置项目可以是一个单独的 package，而且也没有必要发布到 npm，直接本地依赖即可，而且我们可以针对 react 项目、nodejs 项目定制不同的规则，各 pacakge 在使用时还可以再修改定制。我个人比较推荐这种方式，虽然看起来可能会麻烦一些，但是后续扩展起来不容易出问题。</li>
</ul>
</li>
</ol>
<p>上面说过推荐使用<code>airbnb</code>的规则作为基础。airbnb 的 eslint 配置并没有 typescript 版本，所以用的是社区的：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/eslint-config-airbnb-typescript">eslint-config-airbnb-typescript</a></p>
<p>然后 eslint-config-airbnb 本身依赖：</p>
<ul>
<li><code>eslint-plugin-import</code>, 上面提到过这个插件</li>
<li><code>eslint-plugin-jsx-a11y</code>，跟 acc 相关的，国内可能不太在意，不过属于 peer dependencies，还是装了吧。</li>
<li><code>eslint-plugin-react</code></li>
<li><code>eslint-plugin-react-hooks</code></li>
</ul>
<p>以及我们上述提过的，为了支持 typescript 必须安装的</p>
<ul>
<li><code>@typescript-eslint/parser</code></li>
<li><code>@typescript-eslint/eslint-plugin</code></li>
</ul>
<p>以及我们上述提过的，为了解决 prettier 和 eslint rules 之间可能冲突问题的</p>
<ul>
<li><code>eslint-config-prettier</code></li>
</ul>
<p><strong>安装 eslint 相关依赖</strong></p>
<p>上面也说过推荐在根目录安装 eslint 相关依赖，所以总结一下，在 root 根目录下执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in ts-mono/</span></span><br><span class="line">yarn add -WD eslint eslint-config-airbnb-typescript \</span><br><span class="line">    eslint-config-airbnb-typescript \</span><br><span class="line">    eslint-config-prettier \</span><br><span class="line">    eslint-plugin-import \</span><br><span class="line">    eslint-plugin-jsx-a11y \</span><br><span class="line">    eslint-plugin-react \</span><br><span class="line">    eslint-plugin-react-hooks \</span><br><span class="line">    @typescript-eslint/eslint-plugin \</span><br><span class="line">    @typescript-eslint/parser</span><br><span class="line"></span><br><span class="line">touch .eslintignore</span><br></pre></td></tr></table></figure>

<p><strong>创建一个 eslint-config package</strong><br>一般我们在 monorepo 里新建一个 package，可以用<code>lerna create</code>来快速生成，不过 lerna 默认生成发布到 npm 的 package，有很多需要改的，所以也可以简单点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in /ts-mono</span></span><br><span class="line"><span class="built_in">cd</span> packages</span><br><span class="line"><span class="comment"># in /ts-mono/packages</span></span><br><span class="line">mkdir eslint-config &amp;&amp; <span class="built_in">cd</span> eslint-config</span><br><span class="line"><span class="comment"># in /ts-mono/packages/eslint-config</span></span><br><span class="line">yarn init -y</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">touch base.js react.js node.js</span><br></pre></td></tr></table></figure>

<p>这里稍微调整一下，把 main 入口改成 base.js，另外把包名改成<code>@flip/eslint-config</code>。当然这里的 scope 自己替换成别的。如果不加 scope，按照 eslint 的命名规范，package 应该叫<code>eslint-config-yourcomp</code>之类的更符合规范。</p>
<p>这些配置都比较简单，不用上 ts，直接用 js 就行，整个 package 包含三个文件：<code>base.js</code>写最基础的 eslint 配置，然后写一个前端项目专用的配置<code>react.js</code>，一个后端项目用的配置<code>node.js</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ts-mono</span><br><span class="line">├── .editorconfig</span><br><span class="line">├── .eslintignore</span><br><span class="line">├── .gitignore</span><br><span class="line">├── lerna.json</span><br><span class="line">├── package.json</span><br><span class="line">├── packages</span><br><span class="line">│   └── eslint-config</span><br><span class="line">│       ├── base.js</span><br><span class="line">│       ├── node.js</span><br><span class="line">│       ├── package.json</span><br><span class="line">│       └── react.js</span><br><span class="line">├── prettier.config.js</span><br><span class="line">└── yarn.lock</span><br><span class="line"></span><br><span class="line">2 directories, 11 files</span><br></pre></td></tr></table></figure>

<p><strong>编写基础配置 base.js</strong></p>
<p>这个 eslint 的写法和自己实际项目需求有关， eslint 配置还请大家阅读 eslint 自身的文档，这里面列几个要点，并给出一个参考。</p>
<ul>
<li>由于主语言是 typescript，所以 parser 需要替换为<code>@typescript-eslint/parser</code></li>
<li>parserOptions.ecmaVersion 按照需要进行设置，比如<code>2020</code></li>
<li>extends 需要依次继承:<code>airbnb-typescript</code>、<code>prettier</code>来解决前面说过的冲突。</li>
<li>plugins 需要包含前面提过的<code>@typescript-eslint/eslint-plugin</code>, <code>eslint-plugin-import</code>。</li>
</ul>
<p>这里给一个基于 airbnb-typescript 规则的参考：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  parser: <span class="string">&quot;@typescript-eslint/parser&quot;</span>,</span><br><span class="line">  parserOptions: &#123;</span><br><span class="line">    ecmaVersion: <span class="number">2020</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">extends</span>: [</span><br><span class="line">    <span class="comment">// recommended by &#x27;eslint-plugin-import</span></span><br><span class="line">    <span class="string">&quot;plugin:import/recommended&quot;</span>,</span><br><span class="line">    <span class="string">&quot;plugin:import/typescript&quot;</span>,</span><br><span class="line">    <span class="comment">// preferred eslint config base</span></span><br><span class="line">    <span class="string">&quot;airbnb-typescript&quot;</span>,</span><br><span class="line">    <span class="comment">// prevent format rules conflict</span></span><br><span class="line">    <span class="string">&quot;prettier&quot;</span>,</span><br><span class="line">  ],</span><br><span class="line">  settings: &#123;&#125;,</span><br><span class="line">  <span class="comment">// leave the plugins to the package level settings</span></span><br><span class="line">  plugins: [<span class="string">&quot;import&quot;</span>, <span class="string">&quot;@typescript-eslint&quot;</span>],</span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="comment">// prefer named export!</span></span><br><span class="line">    <span class="string">&quot;import/prefer-default-export&quot;</span>: <span class="string">&quot;off&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// just as bad as &quot;max components per file&quot;</span></span><br><span class="line">    <span class="comment">// &quot;max-classes-per-file&quot;: &quot;off&quot;,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Missing yarn workspace support</span></span><br><span class="line">    <span class="string">&quot;import/no-extraneous-dependencies&quot;</span>: <span class="string">&quot;off&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里我们先注释掉<code>max-classes-per-file</code>这条规则，方便接下来的测试。</p>
<p><strong>测试 base.js 配置</strong></p>
<p>我们新建一个 nodejs 的 package，故意写一个违反规则的代码文件使用上面定义的配置来检查代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in ts-mono/packages</span></span><br><span class="line">mkdir proj-a &amp;&amp; <span class="built_in">cd</span> proj-a</span><br><span class="line"><span class="comment"># in ts-mono/packages/proj-a</span></span><br><span class="line">yarn init -y &amp;&amp; mkdir src &amp;&amp; touch src/index.ts &amp;&amp; touch tsconfig.json &amp;&amp; touch .eslintrc.js</span><br></pre></td></tr></table></figure>

<p>我们需要手动的修改一下 package.json，加入一个本地开发依赖：我们刚刚创建的<code>@flip/eslint-config</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json for &#x27;proj-a&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;proj-a&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@flip/eslint-config&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来 monorepo 的结构大致是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ts-mono</span><br><span class="line">├── .editorconfig</span><br><span class="line">├── .eslintignore</span><br><span class="line">├── .gitignore</span><br><span class="line">├── lerna.json</span><br><span class="line">├── package.json</span><br><span class="line">├── packages</span><br><span class="line">│   ├── eslint-config</span><br><span class="line">│   │   ├── base.js</span><br><span class="line">│   │   ├── node.js</span><br><span class="line">│   │   ├── package.json</span><br><span class="line">│   │   ├── react.js</span><br><span class="line">│   │   └── yarn.lock</span><br><span class="line">│   └── proj-a</span><br><span class="line">│       ├── .eslintrc.js</span><br><span class="line">│       ├── package.json</span><br><span class="line">│       ├── src</span><br><span class="line">│       │   └── index.ts</span><br><span class="line">│       └── tsconfig.json</span><br><span class="line">├── prettier.config.js</span><br><span class="line">├── tsconfig.json</span><br><span class="line">└── yarn.lock</span><br><span class="line"></span><br><span class="line">4 directories, 17 files</span><br></pre></td></tr></table></figure>

<p>proj-a 的 eslint 配置如下（继承@flip/eslint-config）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">extends</span>: [<span class="string">&quot;@flip/eslint-config&quot;</span>],</span><br><span class="line">  parserOptions: &#123;</span><br><span class="line">    project: <span class="string">&quot;./tsconfig.json&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意一下由于我们使用@typescript-eslint/parser, 这里的<code>parserOptions</code>是必须设置的。</p>
<p>proj-a 的 tsconfig 配置如下（继承 monorepo 根目录下的 tsconfig）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;../../tsconfig.json&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在 proj-a 中故意写一个违背上面提到的<code>max-classes-per-file</code>规则的代码……</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果配置正常，vscode 应该是能够正常反应出 lint 错误：<br><img src="./lint-error.png" alt="lint-error"></p>
<p>如果没有正常显示，检查一下 Eslint 的输出（可以使用 vscode 命令：Eslint: Show Output Channel）看看有什么问题。</p>
<p>接下来可以去<code>eslint-config</code>项目，把<code>base.js</code>里<code>max-classes-per-file</code>规则的注释重新打开，proj-a 项目中的 lint 报错就消除（修改了 eslint 项目后可能需要重启一下 vscode 客户端，其实理论上是需要重启一下 eslint 的插件，但是还没找到重启的方法所以直接重启 vscode 😅）。</p>
<p><strong>react 专用的 lint base</strong></p>
<p>react 专用的 eslint 配置直接继承我们之前测试过的 base，然后加上 react 相关的插件和配置，示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eslint-config/react.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">extends</span>: [<span class="string">&quot;@flip/eslint-config/base&quot;</span>, <span class="string">&quot;plugin:react-hooks/recommended&quot;</span>],</span><br><span class="line">  plugins: [<span class="string">&quot;react&quot;</span>, <span class="string">&quot;react-hooks&quot;</span>],</span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="string">&quot;react/jsx-filename-extension&quot;</span>: [<span class="string">&quot;error&quot;</span>, &#123; <span class="attr">extensions</span>: [<span class="string">&quot;.js&quot;</span>, <span class="string">&quot;.tsx&quot;</span>] &#125;],</span><br><span class="line">    <span class="string">&quot;react/jsx-props-no-spreading&quot;</span>: <span class="string">&quot;off&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>nodejs 环境的 lint base</strong></p>
<p>nodejs 项目用的 eslint 配置同样是继承 base，最基础的只需要一行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eslint-config/node.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">extends</span>: [<span class="string">&quot;@flip/eslint-config/base&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>具体使用上面的例子已经 cover 了，总结一下就是：</p>
<ul>
<li>在项目中声明依赖<code>&quot;@flip/eslint-config&quot;: &quot;*&quot;</code></li>
<li>创建项目的<code>.eslintrc.js</code>，然后 extends<code>@flip/eslint-config</code>或者具体某个配置：<code>@flip/eslint-config/node</code>, <code>@flip/eslint-config/react</code></li>
<li>添加<code>tsconfig.json</code>继承 monorepo 根目录的配置，做出自己的修改</li>
<li>配置<code>.eslintrc.js parserOptions</code></li>
</ul>
<p>到这里一个基础版的 monorepo 就设置完了。接下来有空可能会写一些 walkthroughs 包括在 monorepo 里添加 react 组件项目，cra 项目，nextjs 项目以及纯后端项目。</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/javascript-typescript-mono-repo/" class="post__tag__link">javascript, typescript, mono-repo</a></li></ul><a href="/2020/09/18/ts-mono-settings/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2020 Wan ChengCheng</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer></body></html>